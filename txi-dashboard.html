<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Schindler Total Intelligence – Leadership Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fb;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    .hero {
      background: #001639;
      color: #fff;
      padding: 18px 20px;
      border-radius: 12px;
      margin-bottom: 18px;
    }
    .hero h1 {
      margin: 0 0 4px 0;
      font-size: 22px;
    }
    .hero p {
      margin: 0;
      font-size: 13px;
      opacity: 0.8;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      min-height: 260px;
    }
    .card h2 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: #032d60;
    }
    .card p.subtitle {
      margin: 0 0 12px 0;
      font-size: 12px;
      color: #5e6a7f;
    }
    textarea {
      width: 100%;
      resize: vertical;
      min-height: 110px;
      font-family: inherit;
      font-size: 14px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d8dde6;
      box-sizing: border-box;
    }
    .example {
      font-size: 12px;
      color: #5e6a7f;
      margin-top: 6px;
    }
    .example strong {
      color: #032d60;
    }
    .actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      background: #0176d3;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    button.secondary {
      background: #e5f2ff;
      color: #032d60;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .answer {
      font-size: 14px;
      color: #051927;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .answer-placeholder {
      font-size: 13px;
      color: #8a94a6;
    }
    .status {
      margin-top: 10px;
      font-size: 12px;
      color: #5e6a7f;
    }
    .status span.badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 4px;
    }
    .ok {
      background: #e3fcef;
      color: #046c4e;
    }
    .err {
      background: #fee4e2;
      color: #b42318;
    }
    .backend-error {
      margin-top: 10px;
      font-size: 12px;
      color: #b42318;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="hero">
    <h1>Schindler Total Intelligence – Leadership Console</h1>
    <p>Ask one question and combine live signals from ServiceNow, Salesforce, and SharePoint into a single executive view.</p>
  </div>

  <div class="grid">
    <!-- LEFT: QUESTION -->
    <div class="card">
      <h2>Ask the organisation one question</h2>
      <p class="subtitle">Type a leadership-level question in plain language.</p>

      <textarea id="questionInput"
        placeholder="What are the top 3 operational issues I should care about today, and what’s the business impact?"></textarea>

      <div class="example">
        Example:<br/>
        <strong>What are the top 3 operational issues I should care about today, and what’s the business impact?</strong><br/>
        or<br/>
        <strong>Give me a leadership view of today’s biggest risks and customer impacts.</strong>
      </div>

      <div class="actions">
        <button type="button" class="secondary" id="exampleBtn">Use example question</button>
        <button type="button" id="askBtn">Ask</button>
        <div id="loadingText" style="font-size: 12px; color:#5e6a7f; display:none;">Thinking across systems…</div>
      </div>

      <div id="backendError" class="backend-error"></div>
    </div>

    <!-- RIGHT: ANSWER -->
    <div class="card">
      <h2>Combined view across systems</h2>
      <p class="subtitle">AI assistant answer with traceability to each source system.</p>

      <div id="answer" class="answer-placeholder">
        Could not generate an answer yet. Ask a question on the left to see a combined view.
      </div>

      <div id="status" class="status"></div>
    </div>
  </div>
</div>

<script>
  // IMPORTANT: Backend endpoint (GET with ?question=...)
  const API_URL = "https://ai-bot-backend-black.vercel.app/api/txi-dashboard";

  const questionInput = document.getElementById("questionInput");
  const askBtn = document.getElementById("askBtn");
  const exampleBtn = document.getElementById("exampleBtn");
  const answerEl = document.getElementById("answer");
  const statusEl = document.getElementById("status");
  const backendErrorEl = document.getElementById("backendError");
  const loadingText = document.getElementById("loadingText");

  const exampleQuestion =
    "What are the top 3 operational issues I should care about today, and what’s the business impact?";

  exampleBtn.addEventListener("click", () => {
    questionInput.value = exampleQuestion;
  });

  askBtn.addEventListener("click", () => {
    const q = questionInput.value.trim();
    if (!q) return;
    callBackend(q);
  });

  questionInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
      e.preventDefault();
      askBtn.click();
    }
  });

  async function callBackend(question) {
    askBtn.disabled = true;
    exampleBtn.disabled = true;
    backendErrorEl.textContent = "";
    loadingText.style.display = "inline";

    answerEl.className = "answer-placeholder";
    answerEl.textContent = "Thinking across ServiceNow, Salesforce and SharePoint…";

    statusEl.textContent = "";

    try {
      const url = API_URL + "?question=" + encodeURIComponent(question);

      // GET – this matches the backend that says "Use GET"
      const resp = await fetch(url, { method: "GET" });

      if (!resp.ok) {
        const text = await resp.text();
        backendErrorEl.textContent = "Backend error: " + text;
        answerEl.textContent = "Could not generate an answer.";
        return;
      }

      const data = await resp.json();

      // Main combined answer
      if (data.combinedAnswer) {
        answerEl.className = "answer";
        answerEl.textContent = data.combinedAnswer;
      } else {
        answerEl.className = "answer-placeholder";
        answerEl.textContent = "No combined answer returned from backend.";
      }

      // Source-level status
      const src = data.sources || {};
      const parts = [];

      if (src.serviceNow) {
        if (src.serviceNow.error) {
          parts.push(`<span class="badge err">ServiceNow: error</span>`);
        } else {
          parts.push(`<span class="badge ok">ServiceNow: OK</span>`);
        }
      }
      if (src.salesforce) {
        parts.push(
          `<span class="badge ${src.salesforce.error ? "err" : "ok"}">Salesforce: ${
            src.salesforce.error ? "error" : "OK"
          }</span>`
        );
      }
      if (src.sharePoint) {
        parts.push(
          `<span class="badge ${src.sharePoint.error ? "err" : "ok"}">SharePoint: ${
            src.sharePoint.error ? "error" : "OK"
          }</span>`
        );
      }

      statusEl.innerHTML = parts.join(" ");
    } catch (e) {
      backendErrorEl.textContent = "Frontend error: " + e.message;
      answerEl.className = "answer-placeholder";
      answerEl.textContent = "Could not generate an answer.";
    } finally {
      askBtn.disabled = false;
      exampleBtn.disabled = false;
      loadingText.style.display = "none";
    }
  }
</script>
</body>
</html>
